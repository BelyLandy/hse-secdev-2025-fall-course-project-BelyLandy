name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "tests/**"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "tests/**"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"

permissions:
  contents: read

concurrency:
  group: sast-secrets-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write
      issues: write

    env:
      SEMGREP_VERSION: "1.84.0"
      GITLEAKS_VERSION: "v8.18.4"
      SARIF_PATH: EVIDENCE/P10/semgrep.sarif
      GITLEAKS_JSON: EVIDENCE/P10/gitleaks.json

    steps:
      - uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P10

      - name: Install jq (for summary)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Semgrep CI (SARIF)
        run: |
          docker run --rm -v $PWD:/src -w /src returntocorp/semgrep:${SEMGREP_VERSION} \
            semgrep ci --config p/ci --config /src/security/semgrep/rules.yml \
              --metrics=off --sarif -o /src/${SARIF_PATH} || true
          test -s "${SARIF_PATH}" || echo '{"runs":[{"results":[]}],"version":"2.1.0"}' > "${SARIF_PATH}"

      - name: Upload SARIF to Code Scanning
        if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.SARIF_PATH }}

      - name: Gitleaks detect (JSON)
        run: |
          docker run --rm -v $PWD:/repo -w /repo zricethezav/gitleaks:${GITLEAKS_VERSION} \
            detect --no-banner --config=/repo/security/.gitleaks.toml \
              --source=/repo --report-format=json \
              --report-path=/repo/${GITLEAKS_JSON} || true
          test -s "${GITLEAKS_JSON}" || echo '[]' > "${GITLEAKS_JSON}"

      - name: Build SAST & Secrets triage (counts + severity)
        id: triage
        run: |
          SEM_TOTAL=$(jq -r '[.runs[]?.results[]?] | length // 0' "${SARIF_PATH}")

          SEM_LEVELS=$(jq -c '
            [.runs[]?.results[]?
              | (.level // null)
              | select(. != null)
            ]
            | group_by(.)
            | map({ (.[0]): length })
            | add // {}
          ' "${SARIF_PATH}")

          SEM_TOP=$(jq -rc '
            [ .runs[]?.results[]?
              | (.ruleId // null)
              | select(. != null)
            ]
            | group_by(.)
            | map({id: .[0], cnt: length})
            | sort_by(-.cnt)
            | .[:5]
          ' "${SARIF_PATH}" || echo '[]')

          GL_TOTAL=$(jq -r 'if type=="array" then length else 0 end' "${GITLEAKS_JSON}" 2>/dev/null || echo 0)

          GL_TOP=$(jq -rc '
            if type=="array" then
              (group_by(.RuleID)
                | map({id: (.[0].RuleID // "unknown"), cnt: length})
                | sort_by(-.cnt)
                | .[:5]
              )
            else
              []
            end
          ' "${GITLEAKS_JSON}" 2>/dev/null || echo '[]')

          echo "sem_total=${SEM_TOTAL}"   >> $GITHUB_OUTPUT
          echo "sem_levels=${SEM_LEVELS}" >> $GITHUB_OUTPUT
          echo "sem_top=${SEM_TOP}"       >> $GITHUB_OUTPUT
          echo "gl_total=${GL_TOTAL}"     >> $GITHUB_OUTPUT
          echo "gl_top=${GL_TOP}"         >> $GITHUB_OUTPUT

          {
            echo "# P10 SAST & Secrets summary (triage)"
            echo
            echo "- Commit: \`${GITHUB_SHA}\`"
            echo "- Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo
            echo "## Semgrep"
            echo "- Total findings: ${SEM_TOTAL}"
            echo "- By level: \`${SEM_LEVELS}\`"
            echo "- Top rules: \`${SEM_TOP}\`"
            echo
            echo "## Gitleaks"
            echo "- Total findings: ${GL_TOTAL}"
            echo "- Top rules: \`${GL_TOP}\`"
            echo
            echo "## Next steps"
            if [ "${SEM_TOTAL}" -gt 0 ] || [ "${GL_TOTAL}" -gt 0 ]; then
              echo "- Создаём Issue со ссылкой на ран, прикладываем артефакты и план фикса/срок."
            else
              echo "- Находок нет. Держим правила в актуальном состоянии; при появлении находок — фикс/ротация секретов, либо точечный allowlist c обоснованием."
            fi
          } > EVIDENCE/P10/sast_summary.md

      - name: Create triage Issue when findings detected
        if: ${{ steps.triage.outputs.sem_total != '0' || steps.triage.outputs.gl_total != '0' }}
        uses: actions/github-script@v7
        env:
          SEM_TOTAL: ${{ steps.triage.outputs.sem_total }}
          SEM_LEVELS: ${{ steps.triage.outputs.sem_levels }}
          GL_TOTAL: ${{ steps.triage.outputs.gl_total }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sem = parseInt(process.env.SEM_TOTAL || '0', 10);
            const gl  = parseInt(process.env.GL_TOTAL  || '0', 10);
            const title = `P10 triage: ${sem} Semgrep / ${gl} Gitleaks findings @ ${context.sha.substring(0,7)}`;
            const body = [
              `Automated triage for commit \`${context.sha}\`.`,
              ``,
              `Run: ${process.env.RUN_URL}`,
              ``,
              `- Semgrep total: ${sem}`,
              `- Semgrep by level: ${process.env.SEM_LEVELS}`,
              `- Gitleaks total: ${gl}`,
              ``,
              `Artifacts: download \`P10_EVIDENCE-${context.sha}\` in the run page (EVIDENCE/P10/*).`,
              ``,
              `Next steps: review findings, fix blocking, for non-blocking — backlog with due date / allowlist with rationale.`
            ].join("\n");
            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['security', 'P10', 'triage']
            });
            core.info(`Created issue #${res.data.number}`);

      - name: Evidence README
        run: |
          {
            echo "# P10 Evidence"
            echo
            echo "- semgrep.sarif — SARIF-отчёт Semgrep (профиль \`p/ci\` + \`security/semgrep/rules.yml\`)."
            echo "- gitleaks.json — отчёт Gitleaks (\`security/.gitleaks.toml\`)."
            echo "- sast_summary.md — краткая сводка (commit, run URL, counts)."
            echo
            echo "Commit: ${GITHUB_SHA}"
            echo "Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } > EVIDENCE/P10/README.md

      - name: Job summary
        run: |
          SEM="${{ steps.triage.outputs.sem_total }}"
          GL="${{ steps.triage.outputs.gl_total }}"
          echo "## SAST & Secrets (P10)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: [${GITHUB_SHA::7}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})" >> "$GITHUB_STEP_SUMMARY"
          echo "- Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}#artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "- Semgrep findings: \`${SEM}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Gitleaks findings: \`${GL}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P10_EVIDENCE-${{ github.sha }}
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/gitleaks.json
            EVIDENCE/P10/sast_summary.md
            EVIDENCE/P10/README.md
          retention-days: 14
